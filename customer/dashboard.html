<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äì KAU Cafeteria</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../CSS/style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
</head>
<body>
    <div class="bg-pattern"></div>
    <div class="container">
        <header>
            <div class="logo-area">
                <div class="logo-icon">üçΩÔ∏è</div>
                <div>
                    <h1>KAU Cafeteria</h1>
                    <span class="tagline">My Dashboard</span>
                </div>
            </div>
            <div class="user-actions">
                <span id="user-name"></span>
                <button id="logout-btn" class="btn secondary">Logout</button>
            </div>
        </header>

        <main>
            <div id="alert-container"></div>

            <!-- Loading overlay -->
            <div id="page-loading" style="text-align:center;padding:3rem">
                <div class="spinner"></div>
                <p style="color:var(--muted);margin-top:1rem">Loading your account‚Ä¶</p>
            </div>

            <div id="page-content" style="display:none">

                <!-- Account Info -->
                <div class="dashboard-section">
                    <h2>üë§ Account Information</h2>
                    <p id="user-email" style="color:var(--muted);margin-bottom:0.3rem"></p>
                    <p id="user-status" style="color:var(--teal);font-weight:600;margin-bottom:1rem"></p>
                    <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
                        <div class="balance-badge">
                            üí∞ Balance: <span class="amount" id="user-balance">0.00</span> SAR
                        </div>
                        <button id="add-balance-btn" class="btn">Add Balance</button>
                    </div>
                </div>

                <!-- Today's Menu -->
                <div class="dashboard-section">
                    <h2>üìã Today's Menu</h2>
                    <p class="section-sub" id="dashboard-date"></p>
                    <div id="dashboard-menu" class="menu-grid">
                        <div class="menu-loading"><div class="spinner"></div><p>Loading menu‚Ä¶</p></div>
                    </div>
                </div>

                <!-- Purchase Tickets -->
                <div class="dashboard-section">
                    <h2>üéüÔ∏è Purchase Tickets</h2>
                    <div class="meal-options">
                        <div class="meal-card">
                            <h3>üåÖ Breakfast</h3>
                            <p class="original-price">13.50 SAR</p>
                            <p class="your-price" id="breakfast-price">13.50 SAR</p>
                            <button class="btn buy-btn" data-meal="breakfast" data-price="13.50">Buy Ticket</button>
                        </div>
                        <div class="meal-card">
                            <h3>‚òÄÔ∏è Lunch</h3>
                            <p class="original-price">23.00 SAR</p>
                            <p class="your-price" id="lunch-price">23.00 SAR</p>
                            <button class="btn buy-btn" data-meal="lunch" data-price="23.00">Buy Ticket</button>
                        </div>
                        <div class="meal-card">
                            <h3>üåô Dinner</h3>
                            <p class="original-price">23.00 SAR</p>
                            <p class="your-price" id="dinner-price">23.00 SAR</p>
                            <button class="btn buy-btn" data-meal="dinner" data-price="23.00">Buy Ticket</button>
                        </div>
                    </div>
                </div>

                <!-- My Tickets -->
                <div class="dashboard-section">
                    <h2>üé´ My Tickets</h2>
                    <div id="tickets-container" class="tickets-grid"></div>
                </div>

            </div><!-- end page-content -->

            <!-- Add Balance Modal -->
            <div id="balance-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Add Balance</h2>
                    <form id="add-balance-form">
                        <div class="form-group">
                            <label for="amount">Amount (SAR)</label>
                            <input type="number" id="amount" min="10" step="10" value="100">
                        </div>
                        <p style="color:var(--muted);font-size:0.9rem;margin-bottom:1.5rem">
                            üß™ Prototype mode ‚Äî simulates adding balance.
                        </p>
                        <button type="submit" class="btn" id="add-balance-submit">Add Balance</button>
                    </form>
                </div>
            </div>

            <!-- QR Modal -->
            <div id="qr-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Your Ticket</h2>
                    <div id="qr-container" class="qr-display"></div>
                    <div class="ticket-info">
                        <p>Meal: <strong><span id="ticket-meal-type"></span></strong></p>
                        <p>Purchased: <span id="ticket-date"></span></p>
                        <p style="font-size:0.82rem;color:var(--muted);margin-top:0.5rem">
                            Ticket ID: <span id="ticket-full-id" style="font-family:monospace;word-break:break-all"></span>
                        </p>
                    </div>
                    <p class="instructions">Show this QR code to the cafeteria worker.<br>
                    <small>If QR fails, give them the Ticket ID above.</small></p>
                </div>
            </div>
        </main>
        <footer><p>¬© 2025 KAU Cafeteria</p></footer>
    </div>

    <script src="../JS/jsonbin-config.js"></script>
    <script src="../JS/database.js"></script>
    <script src="../JS/auth.js"></script>

    <!-- Menu loading via ES module -->
    <script type="module">
        import { MenuAPI } from '../JS/menu-api.js';
        const today   = new Date();
        const dateKey = today.toISOString().split('T')[0];
        document.getElementById('dashboard-date').textContent =
            today.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

        async function loadMenu() {
            const container = document.getElementById('dashboard-menu');
            const data = await MenuAPI.getForDate(dateKey);
            if (data) {
                const meals = [
                    {key:'breakfast',label:'Breakfast',icon:'üåÖ'},
                    {key:'lunch',    label:'Lunch',    icon:'‚òÄÔ∏è'},
                    {key:'dinner',   label:'Dinner',   icon:'üåô'}
                ];
                container.innerHTML = meals.map(m => {
                    const items = data[m.key] || [];
                    return `<div class="menu-card">
                        <div class="menu-card-header"><span class="meal-icon">${m.icon}</span><h3>${m.label}</h3></div>
                        <ul class="menu-items">
                            ${items.length ? items.map(i=>`<li>${i}</li>`).join('') : '<li class="no-items">Not posted yet</li>'}
                        </ul>
                    </div>`;
                }).join('');
            } else {
                container.innerHTML = '<div class="menu-empty"><p>üìã Today\'s menu hasn\'t been posted yet.</p></div>';
            }
        }
        loadMenu();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {

        // Auth check
        const session = Auth.customer.getCurrentUser();
        if (!session) { window.location.href = 'login.html'; return; }

        // Show loading, hide content
        document.getElementById('page-loading').style.display = 'block';
        document.getElementById('page-content').style.display  = 'none';

        // Fetch fresh user data from cloud
        let currentUser = await Auth.customer.refreshCurrentUser();
        if (!currentUser) { window.location.href = 'login.html'; return; }

        // Show content
        document.getElementById('page-loading').style.display = 'none';
        document.getElementById('page-content').style.display  = 'block';

        // Fill user info
        document.getElementById('user-name').textContent    = currentUser.name;
        document.getElementById('user-email').textContent   = currentUser.email;
        document.getElementById('user-status').textContent  = currentUser.isStudent
            ? 'üéì KAU Student ‚Äî 50% Discount Applied!' : 'üë§ Regular Customer';
        document.getElementById('user-balance').textContent = (currentUser.balance||0).toFixed(2);

        // Apply student discount
        const buyBtns = document.querySelectorAll('.buy-btn');
        if (currentUser.isStudent) {
            document.getElementById('breakfast-price').textContent = (13.50/2).toFixed(2)+' SAR';
            document.getElementById('lunch-price').textContent     = (23.00/2).toFixed(2)+' SAR';
            document.getElementById('dinner-price').textContent    = (23.00/2).toFixed(2)+' SAR';
            buyBtns.forEach(btn => btn.setAttribute('data-price', (parseFloat(btn.getAttribute('data-price'))/2).toFixed(2)));
        }

        await loadTickets();

        // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ
        document.getElementById('logout-btn').addEventListener('click', () => {
            Auth.customer.logout();
            window.location.href = 'login.html';
        });

        // ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
        const balanceModal = document.getElementById('balance-modal');
        const qrModal      = document.getElementById('qr-modal');

        document.getElementById('add-balance-btn').addEventListener('click', () => balanceModal.style.display='block');
        document.querySelectorAll('.close').forEach(btn => {
            btn.addEventListener('click', () => { balanceModal.style.display='none'; qrModal.style.display='none'; });
        });
        window.addEventListener('click', e => {
            if (e.target===balanceModal) balanceModal.style.display='none';
            if (e.target===qrModal)      qrModal.style.display='none';
        });

        // ‚îÄ‚îÄ Add Balance ‚îÄ‚îÄ
        document.getElementById('add-balance-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('add-balance-submit');
            submitBtn.textContent = 'Adding‚Ä¶';
            submitBtn.disabled = true;

            const amount  = parseFloat(document.getElementById('amount').value);
            if (isNaN(amount)||amount<=0) { showAlert('Enter a valid amount','danger'); return; }

            const updated = await DB.users.update(currentUser.id, { balance: (currentUser.balance||0)+amount });
            if (updated) {
                currentUser = { ...updated, password: undefined };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('user-balance').textContent = currentUser.balance.toFixed(2);
                showAlert(`${amount.toFixed(2)} SAR added!`, 'success');
                balanceModal.style.display = 'none';
            }
            submitBtn.textContent = 'Add Balance';
            submitBtn.disabled = false;
        });

        // ‚îÄ‚îÄ Buy Ticket ‚îÄ‚îÄ
        buyBtns.forEach(btn => {
            btn.addEventListener('click', async function() {
                const mealType = this.getAttribute('data-meal');
                const price    = parseFloat(this.getAttribute('data-price'));

                if ((currentUser.balance||0) < price) {
                    showAlert('Insufficient balance. Please add funds.','danger');
                    return;
                }

                this.textContent = 'Buying‚Ä¶';
                this.disabled = true;

                await DB.tickets.create({ userId: currentUser.id, mealType, price });
                const updated = await DB.users.update(currentUser.id, { balance: (currentUser.balance||0)-price });

                if (updated) {
                    currentUser = { ...updated, password: undefined };
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('user-balance').textContent = currentUser.balance.toFixed(2);
                    showAlert(`${mealType.charAt(0).toUpperCase()+mealType.slice(1)} ticket purchased!`,'success');
                    await loadTickets();
                }

                this.textContent = 'Buy Ticket';
                this.disabled = false;
            });
        });

        // ‚îÄ‚îÄ Load Tickets ‚îÄ‚îÄ
        async function loadTickets() {
            const container = document.getElementById('tickets-container');
            container.innerHTML = '<div class="menu-loading"><div class="spinner"></div></div>';
            const tickets = await DB.tickets.getUserTickets(currentUser.id);
            const unused  = tickets.filter(t => !t.used);
            container.innerHTML = '';

            if (unused.length === 0) {
                container.innerHTML = '<p class="no-tickets">No tickets yet. Buy one above! üëÜ</p>';
                return;
            }

            unused.forEach(ticket => {
                const el      = document.createElement('div');
                el.className  = 'ticket-card';
                const meal    = ticket.mealType.charAt(0).toUpperCase()+ticket.mealType.slice(1);
                const date    = new Date(ticket.createdAt).toLocaleDateString();
                const shortId = ticket.id.substring(0,24)+'‚Ä¶';
                el.innerHTML  = `
                    <div class="ticket-header">
                        <h3>${meal}</h3>
                        <span class="ticket-price">${ticket.price.toFixed(2)} SAR</span>
                    </div>
                    <div class="ticket-body">
                        <p>Purchased: ${date}</p>
                        <p style="font-family:monospace;font-size:0.78rem;color:var(--muted);margin-bottom:0.9rem;word-break:break-all" title="${ticket.id}">
                            üîë ${shortId}
                        </p>
                        <button class="btn view-qr-btn"
                            data-ticket-id="${ticket.id}"
                            data-meal-type="${meal}"
                            data-date="${date}">
                            View QR Code
                        </button>
                    </div>`;
                container.appendChild(el);
            });

            // QR buttons
            document.querySelectorAll('.view-qr-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ticketId = this.getAttribute('data-ticket-id');
                    document.getElementById('ticket-meal-type').textContent = this.getAttribute('data-meal-type');
                    document.getElementById('ticket-date').textContent      = this.getAttribute('data-date');
                    document.getElementById('ticket-full-id').textContent   = ticketId;

                    const qrContainer = document.getElementById('qr-container');
                    qrContainer.innerHTML = '';
                    const qr = qrcode(0,'L');
                    qr.addData(ticketId);
                    qr.make();
                    qrContainer.innerHTML = qr.createImgTag(10);
                    qrModal.style.display = 'block';
                });
            });
        }

        function showAlert(msg, type) {
            const el = document.createElement('div');
            el.className = `alert alert-${type}`;
            el.textContent = msg;
            const c = document.getElementById('alert-container');
            c.innerHTML = '';
            c.appendChild(el);
            setTimeout(() => el.remove(), 5000);
        }
    });
    </script>
</body>
</html>
